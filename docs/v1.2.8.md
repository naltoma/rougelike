# v1.2.8: 特殊条件付きステージ実装

## 概要
Stage11-13の特殊条件付きステージシステムを実装。大型敵システム（2x2, 3x3, 2x3）と複雑な敵AI行動パターンを導入し、最終ステージにふさわしい高難易度バトルシステムを構築しました。

## 主な新機能

### 1. 大型敵システム
- **2x2敵**: 4マス占有の大型敵
- **3x3敵**: 9マス占有の超大型敵  
- **2x3敵**: 6マス占有の特殊形状敵
- 完全な衝突検出・視覚表示システム

### 2. Stage11特殊行動システム
- **怒りモード**: HP50%以下で発動
- **3ターンカウントダウン**: 怒り発動後3ターン待機
- **範囲攻撃**: 4ターン目に範囲攻撃実行
- **平常復帰**: 攻撃後即座に平常モードに戻る

### 3. Stage13条件付き撃破システム
- **2x3影の王**: 通常攻撃無効（HP10000）
- **特殊条件**: pickup()→wait()→attack()の順序でのみ撃破可能
- **交互怒りパターン**: 2x2→3x3の交互怒りモード検出
- **自動撃破**: 条件達成で2x3敵即座に消滅

### 4. GUI拡張機能
- **動的凡例システム**: ゲーム状態に応じた凡例表示
- **サイドバー自動調整**: 内容量に応じた高さ調整
- **ヒント統合表示**: YAML設定のヒントをGUIに統合

## 実装されたステージ

### Stage11: 大型敵怒りモード
- 2x2敵（HP1000）、3x3敵（HP2000）配置
- 怒りモード3ターンカウントダウンシステム
- 範囲攻撃（2x2敵=1マス、3x3敵=2マス）

### Stage12: 複数大型敵戦略バトル
- 2x2敵＋3x3敵同時配置
- Stage11_special行動パターン適用
- 戦略的な攻撃順序の学習

### Stage13: 最終ボス複合戦
- 2x2敵＋3x3敵＋2x3特殊敵
- 条件付き撃破システム
- 最高難易度の戦略的思考要求

## 技術的改善

### 敵AI状態管理
```python
# 怒りモード状態遷移
normal → rage_countdown_3 → rage_countdown_2 → rage_countdown_1 → attacking → normal

# 2x3敵特殊状態
monitoring → eliminated (条件達成時)
```

### 交互怒りパターン検出
```python
def has_alternating_rage_pattern(self, history: List[Dict]) -> bool:
    """2x2→3x3の交互怒りパターンを検出"""
    if len(history) < 2:
        return False
    
    pattern_found = False
    for i in range(len(history) - 1):
        current = history[i]
        next_entry = history[i + 1]
        
        if (current.get('enemy_type') == '2x2' and 
            next_entry.get('enemy_type') == '3x3'):
            pattern_found = True
            break
    
    return pattern_found
```

### 範囲攻撃システム
```python
def _calculate_area_attack_positions(self, enemy_pos: Position, 
                                   attack_range: int) -> List[Position]:
    """敵の範囲攻撃座標を計算"""
    positions = []
    for dy in range(-attack_range, attack_range + 1):
        for dx in range(-attack_range, attack_range + 1):
            if abs(dx) + abs(dy) <= attack_range:  # マンハッタン距離
                pos = Position(enemy_pos.x + dx, enemy_pos.y + dy)
                positions.append(pos)
    return positions
```

## ファイル変更

### 主要エンジンファイル
- `engine/game_state.py`: 敵AI行動システム、状態管理、パターン検出
- `engine/api.py`: 大型敵属性設定、エラーハンドリング  
- `engine/renderer.py`: 動的凡例システム、大型敵描画
- `engine/enemy_system.py`: 大型敵システム、範囲攻撃計算

### ステージ設定
- `stages/stage11.yml`: 怒りモードステージ設定
- `stages/stage12.yml`: 複数大型敵ステージ設定  
- `stages/stage13.yml`: 最終ボス複合戦ステージ設定

### テストシステム
- プロジェクトルートのテストファイルを`tests/`に整理
- 6個のテストファイルを移動、import文修正で実行可能に

## 学習目標達成

### Stage11
- 大型敵の基本理解
- 怒りモードメカニズム習得
- タイミング戦略の学習

### Stage12  
- 複数大型敵の同時管理
- 戦略的攻撃順序決定
- リソース管理能力向上

### Stage13
- 最高難易度戦略的思考
- 条件付き撃破システム理解
- 全スキル統合能力

## 今後の展開
v1.2.8で基本的なローグライクフレームワークが完成。今後は：
- より複雑なパズル要素
- マルチステージクリア条件
- アイテム・スキルシステム拡張
- 学習進捗分析システム

## バージョン履歴
- v1.2.8: 特殊条件付きステージ（Stage11-13）・大型敵システム・特殊敵システム実装
- 前バージョン: [v1.2.7](v1.2.7.md) - wait()API導入・敵AI視覚システム

