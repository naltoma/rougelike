# v1.2.13: スタミナシステム実装

## 概要
プレイヤーにスタミナ（行動力）の概念を導入し、ターン消費系アクション実行時にスタミナを消費するシステムを実装しました。スタミナが尽きるとHPが0になり即死します。

## 実装機能

### 1. スタミナ基本機能
- **初期値**: デフォルト20（ステージYAMLで個別設定可能）
- **消費**: ターン消費系アクション（move, turn_left, turn_right, attack, pickup, dispose）で -1
- **回復**: wait()実行時、敵が非アラート状態なら +10（最大値上限）
- **枯渇時**: スタミナ0でHP=0、即死

### 2. 有効化設定
```python
# main.py または main_hoge4.py で
ENABLE_STAMINA = True  # スタミナシステム有効化
```

デフォルトは `False`（後方互換性のため）。

### 3. ステージYAML設定（オプション）
```yaml
player:
  start: [5, 2]
  direction: "N"
  hp: 100
  max_hp: 100
  stamina: 5          # 初期スタミナ（オプション、デフォルト: 20）
  max_stamina: 5      # 最大スタミナ（オプション、デフォルト: 20）
```

省略時はデフォルト値（20/20）が使用されます。

### 4. 新API
```python
# プレイヤーの現在スタミナを取得
current_stamina = get_stamina()
```

`get_stage_info()` の返り値にも `"player_stamina"` と `"player_max_stamina"` が追加されました。

### 5. GUI/CUI表示
- **CUI**: `⚡ スタミナ: 18/20` のように表示
- **GUI**: スタミナゲージを表示、変化時には色で強調表示
  - 減少時: オレンジ色でハイライト
  - 回復時: シアン色でハイライト

## 技術詳細

### アーキテクチャ
1. **Character dataclass** (`engine/__init__.py`)
   - `stamina`, `max_stamina` フィールド追加
   - `consume_stamina(amount)`: 消費処理、0で即死
   - `recover_stamina(amount)`: 回復処理、上限あり

2. **HyperParameterManager** (`engine/hyperparameter_manager.py`)
   - `enable_stamina` フラグ追加（デフォルト: False）
   - シングルトンパターンで全システム共通の設定を管理

3. **StageLoader** (`engine/stage_loader.py`)
   - YAMLから `stamina`, `max_stamina` を読み込み
   - Stage dataclassに設定を渡す

4. **GameStateManager** (`engine/game_state.py`)
   - `execute_command()`: ターン消費系コマンドでスタミナ消費判定
   - `initialize_game()`: スタミナパラメータを受け取りCharacterに設定

5. **WaitCommand** (`engine/commands.py`)
   - 敵が非アラート状態なら +10 回復
   - アラート状態では回復なし

6. **Renderer** (`engine/renderer.py`)
   - CUI/GUIでスタミナ表示
   - StatusChangeTrackerと統合し、変化をハイライト表示

### フラグ連携フロー
```
main.py: ENABLE_STAMINA = True
    ↓
setup_stage() 実行
    ↓
hyperparameter_manager.data.enable_stamina = ENABLE_STAMINA
    ↓
各システムが hyper_manager.data.enable_stamina を参照
    ↓
スタミナ表示・消費・回復が有効化
```

## テスト

### テストファイル
1. **test_enable_stamina_simple.py** - フラグ動作確認（シングルトン、設定連携）
2. **test_stamina_in_game.py** - 実ゲーム環境での消費テスト
3. **tests/integration/test_stamina_*.py** - 統合テスト（消費、回復、無効化など）
4. **stages/test_stamina_*.yml** - テスト用ステージ（低スタミナ、回復テストなど）

### 実行結果
```bash
# フラグ動作確認
$ python test_enable_stamina_simple.py
✅ テスト成功: ENABLE_STAMINAフラグが正しく機能します

# ゲーム内消費確認
$ python test_stamina_in_game.py
✅ テスト成功: 実ゲーム環境でスタミナ消費が正しく機能しています

# 統合テスト
$ python -m pytest tests/integration/test_stamina_*.py -v
6 passed
```

## 使用例

### 基本的な使い方
```python
# main_hoge4.py
ENABLE_STAMINA = True  # スタミナシステムON

def solve():
    # スタミナを確認
    stamina = get_stamina()
    print(f"現在のスタミナ: {stamina}")

    # スタミナが少ない場合は待機して回復
    if stamina < 5:
        wait()  # 敵が非アラートなら +10 回復

    # 通常の行動
    move()  # -1 消費
```

### ステージ設計例
```yaml
# stages/stamina_challenge.yml
player:
  stamina: 10          # 少なめのスタミナでチャレンジ性を高める
  max_stamina: 10
```

## 後方互換性
- **デフォルトOFF**: `ENABLE_STAMINA = False` で従来通りの動作
- **既存ステージ**: スタミナ設定がなくてもエラーにならない（デフォルト値使用）
- **既存テスト**: 全13ステージで動作確認済み（`test_all_stages.py`）

## 制限事項
- ターン消費しないコマンド（see, get_stage_info など）はスタミナ消費なし
- 敵の行動にはスタミナの概念なし（プレイヤー専用）
- スタミナ回復はwait()実行時のみ（自然回復なし）

## 変更ファイル一覧
```
engine/__init__.py                  - Character, Stage にスタミナフィールド追加
engine/hyperparameter_manager.py   - enable_stamina フラグ追加、シングルトン化
engine/stage_loader.py              - YAML スタミナ読み込み
engine/game_state.py                - スタミナ消費ロジック、初期化拡張
engine/commands.py                  - wait() 回復ロジック
engine/api.py                       - get_stamina() API追加
engine/renderer.py                  - CUI/GUI スタミナ表示
main.py                             - ENABLE_STAMINA フラグ、setup_stage() 連携
stages/test_stamina_*.yml           - テスト用ステージ
tests/integration/test_stamina_*.py - 統合テスト
test_*.py                           - 動作確認テスト
```

## 修正した問題

### ENABLE_STAMINAフラグが機能しない問題
**問題**: ユーザーが `main_hoge4.py` で `ENABLE_STAMINA = True` を設定しても、スタミナが表示されず消費もされない

**原因**: `ENABLE_STAMINA` フラグが定義されていたが、`HyperParameterManager` に接続されていなかった

**修正**: [main.py:165](main.py#L165) の `setup_stage()` 関数で以下を追加:
```python
# v1.2.13: スタミナシステム設定
hyperparameter_manager.data.enable_stamina = ENABLE_STAMINA
print(f"⚡ スタミナシステム: {'有効' if ENABLE_STAMINA else '無効'}")
```

これにより、ユーザーが設定したフラグがシステム全体に正しく反映されるようになりました。

### GUI表示の文字化け問題
**問題**: GUI画面でスタミナ表示が文字化けする

**原因**: スタミナ表示ラベルが日本語「スタミナ:」で記述されていた

**修正**: [engine/renderer.py:902,926,930](engine/renderer.py#L902) で以下を変更:
```python
# 修正前
base_text = f"スタミナ: "

# 修正後
base_text = f"Stamina: "
```

### get_stamina() API がステージYAMLに記載されていないと使えない問題
**問題**: `ENABLE_STAMINA = True` を設定しても、ステージYAMLの `allowed_apis` に `get_stamina` が記載されていないと使用できない

**原因**: `allowed_apis` はYAMLファイルの記載内容をそのまま使用しており、スタミナシステムの有効/無効状態を考慮していなかった

**修正**: [engine/api.py:197-203](engine/api.py#L197) の `initialize_stage()` 関数で以下を追加:
```python
# API制限設定
self.current_stage_id = stage_id
self.allowed_apis = stage.allowed_apis.copy()  # Copy to avoid modifying original

# v1.2.13: ENABLE_STAMINA が有効な場合、get_stamina を自動追加
from .hyperparameter_manager import HyperParameterManager
hyper_manager = HyperParameterManager()
if hyper_manager.data.enable_stamina and "get_stamina" not in self.allowed_apis:
    self.allowed_apis.append("get_stamina")
```

これにより、`ENABLE_STAMINA = True` の場合は自動的に `get_stamina` が利用可能になります。

## まとめ
v1.2.13では、**スタミナシステム**を導入し、プレイヤーの行動に新たなリソース管理の要素を追加しました。`ENABLE_STAMINA = True` の1行設定で簡単に有効化でき、既存システムとの互換性も維持されています。

---

**バージョン**: v1.2.13
**実装日**: 2025-09-30
**テスト状況**: ✅ 全テスト合格