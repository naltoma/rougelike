# v1.2.4: 初回実行動作改善（初期確認モード機能）

## 概要
Python初学者向けローグライク演習フレームワークのv1.2.4では、初回実行時の学習体験を大幅に改善しました。学生がステージ内容を理解してからコードを記述できるよう、初回確認モードを導入しています。

## 新機能

### 🔰 初回確認モード
- **目的**: 初回実行時にステージ内容の理解を促進
- **動作**: ステージ説明表示 → GUI表示 → 理解確認 → 実行モード移行
- **効果**: 学習効率向上、段階的な理解促進

### 📚 ステージ理解待機システム
- ステージ詳細情報の表示（目標、制約、利用可能API等）
- GUIでの初期状態確認
- solve()実行前の理解促進

### 🔧 柔軟なモード切り替え
- `ENABLE_LOGGING = False`: 確認モード（初回のみ）
- `ENABLE_LOGGING = True`: 実行モード（セッションログ記録）

## 実装詳細

### 新規コンポーネント

#### 1. InitialConfirmationFlagManager
**ファイル**: `engine/initial_confirmation_flag_manager.py`
```python
class InitialConfirmationFlagManager:
    def is_first_execution(stage_id: str, student_id: str) -> bool
    def mark_stage_intro_displayed(stage_id: str) -> None
    def get_confirmation_mode() -> bool
    def set_confirmation_mode(mode: bool) -> None
```

**機能**:
- 初回実行判定
- ステージ説明表示履歴管理
- 確認モード/実行モード切り替え

#### 2. StageDescriptionRenderer
**ファイル**: `engine/stage_description_renderer.py`
```python
class StageDescriptionRenderer:
    def display_stage_conditions(stage_id: str, student_id: str) -> str
    def display_fallback_message(stage_id: str) -> str
```

**機能**:
- 構造化されたステージ説明表示
- エラー時のフォールバック表示
- 学習者向けの分かりやすいフォーマット

#### 3. ConditionalSessionLogger
**ファイル**: `engine/conditional_session_logger.py`
```python
class ConditionalSessionLogger:
    def conditional_log_start(execution_mode: bool, **kwargs) -> dict
    def conditional_log_end(execution_mode: bool, **kwargs) -> dict  
    def conditional_log_event(execution_mode: bool, **kwargs) -> dict
    def should_log_session(execution_mode: bool) -> bool
```

**機能**:
- 実行モードに応じた条件付きログ記録
- 確認モード時のログ除外
- セッションログの効率的管理

### 拡張コンポーネント

#### HyperParametersData拡張
**ファイル**: `engine/hyperparameter_manager.py`
```python
@dataclass
class HyperParametersData:
    initial_confirmation_mode: bool = False  # v1.2.4新機能
    stage_intro_displayed: Dict[str, bool] = field(default_factory=dict)  # v1.2.4新機能
```

**追加フィールド**:
- `initial_confirmation_mode`: 確認/実行モード切り替えフラグ
- `stage_intro_displayed`: ステージ説明表示履歴

### エラーハンドリングシステム

#### 4. 専用例外クラス
- **StageDescriptionError**: ステージ説明表示関連エラー
- **InitialConfirmationModeError**: 初回確認モード関連エラー

**ファイル**:
- `engine/stage_description_error.py`
- `engine/initial_confirmation_mode_error.py`

## 使用方法

### 初回実行フロー
1. **確認モード開始**
   ```
   🔰 初回実行検出：ステージ理解モード
   ステージの内容を理解してからコードを書きましょう。
   ```

2. **ステージ詳細表示**
   - ステージタイトルと説明
   - ボードサイズとプレイヤー位置
   - 利用可能API一覧
   - 制約条件
   - 敵・アイテム情報

3. **GUI表示確認**
   - ステージの初期状態を視覚的に確認
   - マップ、プレイヤー、ゴール位置の確認

4. **実行モード移行**
   ```
   🔧 実行モードへの切り替え方法:
   ハイパーパラメータ設定で ENABLE_LOGGING = True に設定
   ```

### 設定パラメータ

```python
# main.pyの設定部分
ENABLE_LOGGING = False  # 確認モード（初回のみ）
ENABLE_LOGGING = True   # 実行モード（セッションログ記録）
```

## 動作例

### 確認モード実行
```bash
$ python main.py
🔰 初回確認モードを確認中...
🔰 初回実行検出：ステージ理解モード
================================================================================
このステージを初めて実行します。
まずはステージの内容を理解してからコードを書きましょう。

📋 ステージ詳細情報
================================================================================
🎯 ステージ: stage01 - 基本移動の学習
📝 説明: プレイヤーを操作してゴールまで移動してください。

🔧 実行モードへの切り替え方法:
ハイパーパラメータ設定で ENABLE_LOGGING = True に設定

================================================================================
📚 ステージ理解完了
================================================================================
ステージの内容と攻略方法を理解できましたか？
理解できたら、上記の切り替え方法で実行モードに変更して再実行してください。

⏸️ 確認完了後、Escapeキーまたは×ボタンでプログラムを終了してください
（確認モードではsolve()は実行されません）
```

### 実行モード実行
```bash
$ python main.py  # ENABLE_LOGGING = True
🔰 初回確認モードを確認中...
📝 セッションログシステムを初期化中...
✅ 実行モード：セッションログ有効化完了
📂 ログファイル: logs/session_123456A_stage01_20250905_092000.json

🎮 ローグライク演習フレームワーク
[通常の実行フロー継続...]
```

## テスト実装

### テスト構成
- **単体テスト**: 74テストケース
- **統合テスト**: コンポーネント間連携
- **E2Eテスト**: 完全フロー検証

**テストファイル**:
- `tests/test_initial_confirmation_flag_manager.py`
- `tests/test_stage_description_renderer.py`  
- `tests/test_conditional_session_logger.py`
- `tests/test_initial_execution_behavior_integration.py`

### テスト実行結果
```bash
$ python -m pytest tests/ -v
============ 74 passed ============
```

## 技術的詳細

### アーキテクチャ設計原則
1. **分離関心**: 各コンポーネントの責務を明確に分離
2. **疎結合**: インターフェースを通じた連携
3. **拡張性**: 新機能追加に対応可能な設計
4. **エラー処理**: 堅牢なフォールバック機能

### パフォーマンス配慮
- 初回実行判定の効率的なキャッシュ機能
- 軽量なGUIループ（確認モード専用）
- 条件分岐による不要処理の回避

### メモリ管理
- ステージ説明表示履歴の適切な管理
- セッションログの効率的なバッファリング

## v1.2.3からの変更点

### 新機能追加
- ✅ 初回確認モード機能
- ✅ ステージ理解促進システム
- ✅ 条件付きセッションログ機能
- ✅ 包括的エラーハンドリング

### 既存機能強化
- ✅ HyperParameterManager拡張
- ✅ GUI表示フロー改善
- ✅ ユーザーエクスペリエンス向上

### 互換性
- ✅ 既存コードとの完全互換性維持
- ✅ 既存設定ファイルとの互換性
- ✅ 段階的導入可能

## 今後の展望

### v1.2.5予定機能
- ステージ間の学習進捗管理
- 詳細な学習分析機能
- カスタマイズ可能な確認モード設定

### 長期計画
- AIベースの学習支援機能
- 多言語対応
- Webベースインターフェース

## まとめ

v1.2.4では、初回実行時の学習体験を根本的に改善しました。学生がステージ内容を理解してからコード記述に取り組める環境を提供し、段階的学習による効率向上を実現しています。

**主要成果**:
- 📚 **理解促進**: ステージ内容の事前確認機能
- 🎯 **学習効率**: 段階的アプローチによる効率向上
- 🔧 **柔軟性**: 確認/実行モードの柔軟な切り替え
- 🛠️ **堅牢性**: 包括的エラーハンドリング
- 📊 **データ品質**: 適切なセッションログ管理

v1.2.4により、Python初学者向けローグライク演習フレームワークは、より教育効果の高いツールとして進化しました。