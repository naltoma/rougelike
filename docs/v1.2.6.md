# v1.2.6 - Attack System Integration & New Stages (2025-09-10)

## 概要
本バージョンでは、攻撃システム統合とStage04-06の追加を行いました。敵との戦闘機能が完全統合され、段階的な学習が可能になりました。

## 主要機能

### 1. Attack System統合
- **プレイヤー攻撃機能**: `attack()`APIの完全実装
- **カウンター攻撃システム**: 敵が攻撃を受けた後の反撃機能
- **方向転換機能**: 敵が攻撃前にプレイヤー方向を向く動作
- **ダメージ計算統一**: 表示値と実際のダメージを一致

### 2. 新ステージ追加

#### Stage04 - 基本攻撃ステージ
- **目的**: 攻撃機能の基本習得
- **敵設定**: HP10, 攻撃力5
- **戦略**: move()→attack()→move()の基本パターン
- **学習目標**: 攻撃とカウンター攻撃の理解

#### Stage05 - 3回攻撃ステージ  
- **目的**: 複数回攻撃の習得
- **敵設定**: HP90, 攻撃力5 (3回攻撃で撃破)
- **戦略**: move()×3→attack()×3→move()×2
- **学習目標**: 複数ターン戦闘と戦略立案

#### Stage06 - 10倍攻撃ステージ
- **目的**: 長期戦闘の習得
- **敵設定**: HP300, 攻撃力40 (10回攻撃必要)
- **戦略**: move()×3→attack()×10→move()×3
- **学習目標**: 持久戦と位置取り戦略

### 3. GUI改善
- **敵インデックス表示**: 複数敵の識別（1, 2, 3...）
- **Enemy Info Panel**: 敵のHP/攻撃力情報表示
- **ウィンドウサイズ自動調整**: パネル表示に対応した画面サイズ

### 4. Session Log強化
- **コード行数計算改善**: フレームワーク必須行を除外
- **除外対象**: `def`, `from`, `set_auto_render`, `print()`
- **学習データ純度向上**: 実際の学習コード行のみ記録

## 技術改善

### Attack System統合
```python
# プレイヤー攻撃統一
damage = player.attack_power  # 表示値と実際値を一致

# 敵カウンター攻撃（ターン制）
if enemy.direction != required_direction:
    enemy.direction = required_direction  # 方向転換のみ
else:
    combat_system.enemy_attack_player(enemy, player)  # 攻撃
```

### ダメージ設定統一
- **プレイヤー攻撃力**: 10 → 30 (表示と実際を一致)
- **敵ダメージ計算**: `enemy.attack_power` (ステージファイル値)
- **HP設定統一**: `max_hp = hp` (ステージファイル値)

## ファイル構成変更

### 新規追加
- `stages/stage04.yml` - 基本攻撃ステージ定義
- `stages/stage05.yml` - 3回攻撃ステージ定義  
- `stages/stage06.yml` - 10倍攻撃ステージ定義

### 移動・整理
- `debug_code_lines.py` → `tests/debug_code_lines.py`
- `test_code_lines_exclude.py` → `tests/test_code_lines_exclude.py`

## 主要修正箇所

### Core Engine
- `engine/commands.py` - AttackCommandのカウンター攻撃実装
- `engine/combat_system.py` - ダメージ計算統一
- `engine/api.py` - 敵のmax_hp設定修正
- `engine/renderer.py` - 敵インデックス表示、ウィンドウサイズ調整
- `engine/session_log_manager.py` - コード行数計算改善

### Data Models
- `engine/__init__.py` - プレイヤー初期攻撃力30に変更
- `engine/game_state.py` - プレイヤー攻撃力30に統一

## 使用方法

### 新ステージの実行
学習者は各ステージに対応するmain_*.pyファイルを作成し、STAGE_IDを設定して実行します：
```bash
# 例: Stage04の場合、main_stage04.pyを作成し以下を設定
STAGE_ID = "stage04"

# 実行
python main_stage04.py
```

### 攻撃システムAPI
```python
def solve():
    # 敵に接近
    move()
    move()
    move()
    
    # 攻撃（カウンター攻撃に注意）
    attack()  # 敵がこちらを向く（方向転換のみ）
    attack()  # 敵の反撃を受ける
    
    # ゴールへ移動
    move()
    move()
```

### テスト実行
```bash
# コード行数計算テスト
cd tests
python test_code_lines_exclude.py
python debug_code_lines.py
```

## 学習効果

### 段階的スキル習得
1. **Stage01-03**: 基本移動とナビゲーション
2. **Stage04**: 攻撃システム導入
3. **Stage05**: 複数回攻撃戦略
4. **Stage06**: 長期戦闘マネジメント

### 戦略的思考発達
- **位置取り**: 敵との適切な距離感
- **ターン管理**: 攻撃とカウンター攻撃の理解
- **リソース管理**: HP管理と攻撃回数計算
- **効率化**: 最小手数での攻略

## 今後の展開

### v1.2.7以降の予定
- より複雑な敵AI（移動、追跡）
- アイテムシステム統合（武器、防具）
- 大型敵（2x2, 3x3）の実装
- マルチ敵戦闘ステージ

### 学習コンテンツ拡張
- 高度な戦闘アルゴリズム
- 敵行動パターン分析
- 最適化戦略の習得

---

**開発完了日**: 2025年9月10日  
**対象学習者**: Python初学者（プログラミング基礎習得済み）  
**推奨学習順序**: Stage01→02→03→04→05→06