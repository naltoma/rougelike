# Python初学者向け演習フレームワーク：要求仕様ヒアリング＆PRD v0.2

> 目的：本ドキュメントは、Python初学者向けの「ゲーム感覚」演習フレームワークを、要求仕様駆動で具体化するためのワーキングドラフトです。以下はユーザーからのヒアリング回答を反映した更新版です。

---

## 0. ハイライト（エグゼクティブ・サマリ）

- **対象**：大学初学年のPython初学者（講義名例：プログラミング基礎演習）
- **コンセプト**：CUI/GUI（pygame）で動くローグライク風ステージを、学習者が「キャラ操作コード」で攻略。厳密な自動ゴール判定＆クリアログ送信（Google Sheet等）。
- **MVP**：GUI/CUI切替可能。固定ステージ3種（移動／条件分岐／ループ）。YAMLステージ定義。ログ出力→手動送信。conda環境で運用。
- **次フェーズ**：ランダム生成、敵AI、複数学籍番号対応（共同作業ログ）、品質メトリクス分析。

---

## 1. ヒアリング回答まとめ

### A. 受講環境・運用

1. 実行環境：各自PC（macOS多数、Windows一部）
2. 環境構築：condaで追加インストール可
3. オフライン運用：不要
4. ログ送信：**手動送信**（Google Sheets想定）

### B. 学習スコープ・到達目標

5. クラスは応用編でのみ扱う（MVPでは除外）
6. 学習時間：毎週30〜60分 × 7回程度
7. 成績評価：提出状況を確認。品質は加点要素。ログに「実行回数」や「クリア試行履歴」を含める。他学生の達成状況も共有できる仕組みを想定。

### C. 体験設計

8. CUI/GUI両方提供。同じシナリオで動作。`main.py`で選択可能。**デフォルトはGUI**。
9. ローグライク要素：ランダム性は基本排除、オプションステージで導入。敵AIはシンプル。チート対策はオン/オフ切替可能（デフォルトoff）。

### D. 詳細

- 個人識別子：**数字6桁＋英大文字1桁**。匿名化不要。
- LMS連携：不要。
- バリアフリー：色覚対応考慮。
- UI：英語。エラーメッセージは平易に。
- コピー検出：不要。
- 共同作業：保留。ただし複数学籍番号をログに記録可能とするオプションあり。

### API変更提案

- `move_up/down/left/right()`ではなく、**向き制御API**を採用：
  - `turn_left()`, `turn_right()`で向き変更
  - `move()`で正面に移動
  - `attack()`, `pickup()`は継続
  - これにより「向き」の概念を導入し、直感的にシンプル化

---

## 2. 更新後のMVPスコープ

- GUI（pygame）＋CUI（文字ベース）両方提供。切替可能。
- 固定3ステージ：
  - Stage01: 移動（turn/move習得）
  - Stage02: 条件分岐（障害物回避）
  - Stage03: ループとpickup
- ステージはYAMLで定義。
- ログ出力：JSONL/CSV。フィールドに「試行回数」や「再挑戦回数」を追加。
- 手動でGoogle Sheetsに送信。学生自身も他の学生の進捗を参照可能。

---

## 3. API仕様（更新版）

```python
turn_left()      # 左に90度回転
turn_right()     # 右に90度回転
move()           # 正面に1歩進む
attack()         # 正面1マスを攻撃
pickup()         # 足元のアイテムを拾う
see() -> dict    # 正面/左右/足元の情報
```

---

## 4. ログ仕様（更新版）

- フィールド例：
  - `timestamp`
  - `student_id`（6桁数字＋英大文字）
  - `stage_id`
  - `turns`
  - `attempts`（挑戦回数）
  - `result`（pass/fail）
  - `code_sha256`
  - `collaborators`（複数学籍番号オプション）

---

## 5. 次ステップ

- API変更を反映した**engine/api.py雛形**を用意
- GUI/CUI切替を実装（pygameデフォルト）
- ログに「attempts」フィールド追加
- Google Sheets送信スクリプトは手動呼び出し方式

---

> このv0.2はヒアリング結果を反映した更新版です。次のフェーズでは、更新されたAPIとGUI/CUI両対応を組み込んだコード雛形を設計します。

---

## 追補：ヒアリング結果反映（v0.3 差分・詳細仕様確定）

### 1) Google Sheets 運用

- **公開範囲**：学内ドメインの閲覧者全員。
- **編集権限**：教員のみ編集可。学生はツール経由で追記可。同一学生が同一ステージに複数回アップロードした場合は最新を採用し古い方は上書き。
- **匿名化**：なし。
- **保持期間**：手動で対応。
- **シート命名**：`stage01`, `stage02`, …。
- **列順（確定）**：`student_id | timestamp | attempts | turns | result | quality | code | engine_version | stage_version | collaborators`
  - `quality`：codeの行数を記録。
  - `code`：攻略関数本体。別ファイル保存＋リンク参照方式も検討（必須ではない）。
- **レート制御**：1分あたり最大6件。超過時はローカル退避。
- **ダッシュボード指標**：達成率／中央値ターン数／試行回数分布／時系列クリア件数。SNS的good/likeボタンは任意実装（必須ではない）。
- **ダッシュボード実装想定**：Google Sheetsのピボットテーブル＋条件付き書式、あるいはLooker Studio連携。

### 2) ログ仕様

- **code保存範囲**：`solve()`定義全体のみ。
- **サイズ上限**：300行／32KB。超過時は保存拒否。
- **attempts**：実行毎に+1（pass/fail問わず）。
- **result.reason**：`timeout` / `no_required_item` / `invalid_move` / `runtime_error` 等（詳細はステージ設計時に調整）。
- **public列**：削除。公開非公開は全体公開前提。
- **collaborators**：複数IDをカンマ区切り。main.py複製ファイル内に定数として記載、デフォルトは空文字。

### 3) ステージ仕様（MVP〜拡張）

- **基本エリアサイズ**：正方形5x5（stage01〜08）、stage09以降は2倍（10x10）。
- **ステージ詳細**：
  - Stage01: moveのみ（2–3回）。
  - Stage02: turn/moveのみ（3–4回）。
  - Stage03: turn/moveのみ（5–10回）、壁回避を直接記述。
  - Stage04: 攻撃導入。敵は攻撃されたら攻撃し返すのみ（移動なし）。撃破→ゴール。
  - Stage05: 敵は2–3回攻撃で撃破。撃破判定あり。
  - Stage06: キャラと敵のHPを10–20倍に。右下→右上ルート、ループ利用必須。
  - Stage07: pickup導入。武器取得で1回攻撃撃破。未取得で攻撃→END。
  - Stage08: 防具取得で1回耐えて2回攻撃で撃破。未取得で攻撃→END。
  - Stage09: ステージ2倍。ループで簡単に解ける設計。
  - Stage10: 敵AI巡回（壁沿い時計回り）。視界に入ると追跡。武器/防具取得が必須。`wait()`導入も検討。
  - Stage11: 移動不可マス導入（直進ルート強制）。
  - Stage12: Stage11ベースに敵追加。右上から左上へ一本道。前進+攻撃を関数化。
  - Stage13: Stage12に敵追加。左上から左下へ一本道。
  - Stage14: 大型敵（HP50–100倍、2x2 or 3x3）。残HPで怒りモード（攻撃描画変化→即死攻撃）。`see()`で敵状態観測可能。
  - Stage15: 大型敵2x2＋3x3が1体ずつ登場。
  - Stage16: 特殊敵2x3登場。大型敵2x2→3x3の順で怒りモード誘発しないと即死攻撃される。正順で撃破すると特殊敵消滅。
- **発展ステージ**：
  - StageR1〜：turn/moveのみのランダム生成。
  - StageR2〜：attack追加。
  - StageR3〜：pickup追加。
  - StageR4〜：移動不可マス追加。
  - StageR5〜：大型敵追加。
  - StageR6〜：特殊敵追加。

### 4) 評価・運用

- **成績連動**：提出必須。品質（コード行数など）加点対象。
- **遅延提出**：遅延フラグ列を追加。学生はmain.py複製ファイルに「実施日」を記載。日本時間11:50までが遅延なし、それ以降は遅延扱い。
- **再提出**：無制限。
- **不正対策**：MVPでは未実装。将来ON/OFF可能な制限検討。

### 5) 配布と環境

- **環境配布**：`env.yml`配布。ただしREADME.mdで以下を指導：
  1. condaで仮想環境作成
  2. activate
  3. パッケージを1つずつインストール
- **requirements.txt**：env.ymlとの関係をREADME.mdに記載。オプションとして用意。
- **トラブルシュート窓口**：別途用意。システム側には不要。

---

---

## ヒアリング回答反映（v0.3）

### 1. Google Sheets 運用方針（確定）

- **公開範囲**：学内ドメインの閲覧者全員。
- **編集権限**：教員のみ編集可／学生はツール経由で追記可。**同一学生×同一ステージは最新のみ有効**（旧レコードは上書き処理）。
- **保持期間**：手動で対応。
- \`\`**列の既定表示（定義の明確化）**：
  - *意味*：シートを開いた時にコード本文を「常に見せるか／リンクだけにするか／折りたたむか」の既定状態。
  - **提案（既定）**：コードは別ファイル保存→シートは**リンクのみ表示**（`code_url`）。インライン本文（`code`）は非表示列として保持（必要時に展開）。

### 2. シート構成（同一ファイル内・ステージ別シート）

- **シート命名**：`stage01`, `stage02`, ...（採用）。
- **列順（確定）**\
  `student_id | timestamp | late | attempts | turns | result | quality | code_url | code | engine_version | stage_version | collaborators`
  - `late`：遅延提出フラグ（5-2要件）。
  - `quality`：**コード行数**（`solve()` の論理行数）。
  - `code_url`：**別ファイル**に保存したコードへのリンク（Drive等）。
  - `code`：インライン本文（折りたたみ/非表示が既定、検証・検索用フォールバック）。
  - `collaborators`：カンマ区切り。**mainの定数**により学生が記入。
  - 注：先行で合意した `reason` 列は、ユーザ指定の列順に合わせ**一旦省略**（ステージ実装時に必要なら復帰）。

### 3. ログ仕様（更新）

- **保存範囲**：`solve()`関数のみ（定義行〜終端）。
- **サイズ上限**：300行/32KB。
- **カウント**：`attempts`は**実行ごと**に+1（pass/fail問わず）。
- **遅延提出判定**：学生が `performed_date` を main の定数として記載。**日本時間当日 11:50** までを遅延なし、それ以降は `late=true`。
- **公開フラグ**：`public` は**廃止**。

### 4. ダッシュボード（方針）

- **実装想定**：
  1. *Google Sheets だけ*でピボット＆チャート（最小実装）。
  2. 任意で Looker Studio を同一シートに接続（将来拡張）。
- **指標（確定）**：
  - 達成率（pass件数/受講者数）
  - 中央ターン数（ステージ別）
  - 試行回数分布（attempts）
  - 時系列クリア件数（累積/日別）
- **いいね機能（任意）**：SNS風のGood/Likeは**任意要件**として backlog へ（Apps Script のボタン＋別列 `likes` で対応可能）。

### 5. ステージ仕様（詳細確定・MVP 16面＋発展）

- **基本マップ**：正方形、初期は **5×5**。`stage09`以降は**2倍サイズ**（10×10想定）。
- **API**：`turn_left()`, `turn_right()`, `move()`, `attack()`, `pickup()`, `see()`、（必要に応じて）`wait()`。
- 段階的に新規要素追加。各段階におけるステージ数や構成は例示であり、学習難易度をより細分化したり、より適切な段階構成をし直しても構わない。

#### 5.1 turn/moveのみ

- `stage01`：**moveのみ**（2〜3歩）。
- `stage02`：**turn/moveのみ**（3〜4回の曲がり）。
- `stage03`：**turn/moveのみ**（5〜10回）、**壁回避を手続きで直書き**。

#### 5.2 attack導入（敵は移動なし／被攻撃で反撃のみ）

- `stage04`：1回攻撃で撃破→ゴール到達。
- `stage05`：2〜3連続攻撃で撃破→ゴール到達（**撃破判定**が必要）。
- `stage06`：**HPを10〜20倍**に設定。右下スタート→右上の敵を**ループ**で攻撃し撃破。

#### 5.3 pickup導入（敵のHP/ATK増）

- **前提**：素手の1撃では倒せず、敵の1撃でキャラは倒れる設定。
- `stage07`：武器を拾えば**自動装備**→1撃で撃破。拾わず攻撃→**即END**。
- `stage08`：防具を拾えば**1撃耐久**→2撃で撃破。拾わず攻撃→**即END**。
- `stage09`：**マップ2倍**。ループを使うと簡単な配置。
- `stage10`：敵に**移動ルーチン**導入（1マス壁の周囲を時計回り巡回）。**視界検知で追跡**。学生は視界回避で武器/防具を取得→攻撃。\*\*`wait()`\*\*導入可。

#### 5.4 移動不可マス（壁とは別タイプ）

- `stage11`：`stage06`ベース、直進以外不可な**移動不可マス**を配置。
- `stage12`：`stage11`＋敵を左上に追加。右上→左上の一本道。**関数化**（前進×4＋必要攻撃）で再利用を促す。
- `stage13`：`stage12`＋敵を左下に追加。左上→左下の一本道。

#### 5.5 特殊条件付き

- `stage14`：**大型敵**（2×2 or 3×3）。**HP50〜100倍**。残HPが10%減ると**怒りモード**（1ターン溜め→次ターン**即死攻撃**→通常へ）。\`\`**で敵状態を取得**できること。
- `stage15`：大型敵2×2と3×3が各1体。
- `stage16`：**特殊敵 2×3**登場（デフォ反撃あり）。**順序条件**：大型2×2→大型3×3の順で怒り化を誘発。順序ミスで特殊敵が**怒り→追跡→即死攻撃**。順序遵守し2×2撃破→3×3撃破で特殊敵は消滅、クリア。

#### 5.6 発展ステージ（ランダム生成）

- turn/moveのみ → +attack → +pickup → +移動不可 → +大型敵 → +特殊敵 の順で拡張。各段階で\*\*`see()`ベースの自動解法ロジック\*\*設計を要求。

### 6. YAML スキーマ（拡張案）

- `board.size`: `{w: int, h: int}`（初期は5×5、拡張で10×10）
- `tiles`: **2次元格子形式を推奨**。視覚的にわかりやすく配置を定義する。`#`=壁、`X`=移動不可、`.`=床、`E`=敵、`I`=アイテム、`S`=スタート、`G`=ゴール等。例：
  ```yaml
  tiles: |
    #####
    #S..#
    #..E#
    #I.G#
    #####
  ```
  - 内部ではこの文字列をパースし、`walls`や`forbidden`等の座標リストに変換。
  - 拡張ラベル（大文字記号）で特殊敵・大型敵の形状を表現可能。
- `start.player`: `{pos: [x,y], dir: N|E|S|W, hp: int, atk: int}`
- `enemies`: `[{id, type: normal|large_2x2|large_3x3|special_2x3, pos|shape, hp, atk, behavior}]`
- `items`: `[{id, kind: weapon|armor|key, pos, effect:{atk:+X|dr:+X}, auto_equip: bool}]`
- `goal`: `{type: reach|defeat_all|defeat_specific, position: [x,y], require_items:[id,...]}`
- `constraints`: `{max_turns: int}`
- `api`: `allowed: [turn_left, turn_right, move, attack, pickup, see, wait?]`
- `vision`: `{fov: front|4dir, sight_range: int, enemy_state_visible: bool}`（`stage14+`で`enemy_state_visible:true`）

### 7. `see()` 返却仕様（拡張）

- **基本**（MVP初期）：
  ```json
  {"front":"wall|empty|enemy|item", "left":"wall|empty|enemy|item", "right":"wall|empty|enemy|item", "item_here":true|false}
  ```
- **拡張（**\`\`**）**：敵情報を付与（視界内に限る）。
  ```json
  {"front":"enemy","enemy":{"type":"large_2x2","state":"normal|angry|charging","hp_hint":"high|low"}}
  ```

### 8. README 記述（配布・手順）

- **conda 手動手順**：環境作成→activate→個別 `pip install`（教育目的）。
- **env.yml**：同梱。`requirements.txt` も併記し、どちらでも再現可能な手順を明記。
- **学生編集箇所**：`solve()` と `COLLABORATORS = ""`、`PERFORMED_DATE = "YYYY-MM-DD"`（遅延判定用）。

### 9. バックログ（後続検討）

- Apps Script：上書き動作（同一 `student_id`×`stage_id` の最新化）／`likes` 列対応。
- `code`の別ファイル保管：Drive API or Apps Script で**自動アップロード→**\`\`**を記録**（フォールバックとして`code`列に本文も格納）。
- 大型/特殊敵の表現（2×2, 3×3, 2×3）用の当たり判定・描画ルール詳細。

---

## YAML スキーマ拡張：2次元グリッド記法（視認性向上）

**目的**：`tiles` を座標配列だけでなく、\*\*2Dグリッド（文字マップ）\*\*でも記述できるようにし、目視や授業での編集を容易にします。

### 仕様

- `board.repr` に `と` を定義できる。従来の `tiles.blocked/forbidden` 等の**座標配列も引き続き有効**。両方がある場合は \`\`\*\* → 正規化 → 座標配列にマージ\*\*（重複は`grid`優先）。
- 座標系は **(x,y)＝(列, 行)**、**左上が (0,0)**、**yは下方向が正**。
- グリッドは **高さhの配列**または **改行区切りの1文字列**。各行は **幅w** と一致しなければならない。全角文字は不可（1セル＝1文字）。
- `legend` は **文字→意味** の対応表。意味は下記のプリセットキーか、`custom_*` で拡張可能。

### プリセットキー（例）

- `empty`（空セル）
- `wall`（壁＝移動不可）
- `forbidden`（**移動不可マス**：壁と描画を変える）
- `player_N|E|S|W`（開始位置と向き）
- `enemy_normal`／`enemy_large_2x2`／`enemy_large_3x3`／`enemy_special_2x3`
- `item_weapon`／`item_armor`／`item_key`
- `goal`（到達ゴール）

> 大型・特殊敵は **アンカーセル**（左上）に記号を置き、`legend` 側で `shape` を指定します（後述）。

### 正規化ルール

1. `grid` を走査してセルごとに `legend` の意味に解決。
2. `wall` と `forbidden` はそれぞれ `tiles.blocked` / `tiles.forbidden` に座標を追加。
3. `player_*` は `start.player.pos` と `dir` をセット（重複はエラー）。
4. `item_*` は `items` に `{kind,pos}` を追加。IDは自動採番（`w1`,`a1`,`k1` …）か `legend`で`id_prefix`指定。
5. `enemy_*` は `enemies` に `{type,pos,shape?}` を追加。`shape` が必要なタイプは `legend` に明記（例：`2x2`）。
6. `goal` は `goal.position` を設定（複数はエラー）。
7. `empty` は無視。

### 競合時の優先順位

- `grid` → 座標配列へ**上書き**。同じ座標に異なる意味が重なる場合は**エラー**（例：`wall` と `forbidden`）。

### 例：5×5（stage01〜03想定）

```yaml
id: stage03
board:
  size: {w: 5, h: 5}
  repr:
    grid:
      - "P..#."
      - "..#.."
      - "..#G."
      - "..#.."
      - "....."
    legend:
      P: player_E
      .: empty
      #: wall
      G: goal
constraints: {max_turns: 80}
api: {allowed: [turn_left, turn_right, move]}
```

### 例：10×10＋敵/アイテム（stage10想定）

```yaml
id: stage10
board:
  size: {w: 10, h: 10}
  repr:
    grid: |
      P.......#.
      ..#..W..#.
      ..#.....#.
      ..#..A..#.
      ..#####.#.
      .........#
      .#####...#
      .#...E...#
      .#.....G.#
      .########
```
