# v1.2.7 リリースノート

## 概要
v1.2.7では、wait()API導入、敵AIの視覚システム、ステージ毎プレイヤー設定システム、新ステージ(7-10)の追加を行いました。これにより、より高度な敵AI行動と学習体験の多様化を実現しました。

## 主要機能追加

### 1. wait()API導入
- **新API**: `wait()`コマンドを追加
- **用途**: プレイヤーが1ターン待機し、敵の動きを観察
- **教育効果**: 敵の行動パターンを理解する戦略的思考を促進
- **実装**: `engine/api.py`、`engine/commands.py`にWaitCommandを追加

### 2. 敵AI視覚・追跡システム
- **視覚システム**: 敵が方向性を持った視野範囲でプレイヤーを検知
  - 視野角90度、視野距離3マス
  - 壁による視線遮蔽を考慮
- **警戒・追跡モード**: 
  - 発見時に警戒状態(alerted)に移行
  - 10ターンのメモリ機能で見失っても追跡継続
  - 最後に見た位置への追跡機能
- **行動制約**: 敵は1ターンに1つのアクション（移動、方向転換、攻撃）のみ実行

### 3. ステージ毎プレイヤー設定システム
- **柔軟な設定**: ステージファイル(YAML)でプレイヤーのHP、攻撃力を個別設定
- **デフォルト値**: 設定がない場合は標準値(HP:100, 攻撃力:30)を適用
- **ステージ固有調整**: ゲームバランスに応じた細かな調整が可能
- **実装**: `StageLoader`, `GameStateManager`, `Stage`クラスを拡張

### 4. 新ステージ追加

#### ステージ7 - 基本戦闘ステージ
- **目標**: 敵を攻撃して倒してからゴールに到達
- **敵**: 静的なオークが配置
- **学習内容**: attack()の基本的な使用方法

#### ステージ8 - ループ練習ステージ  
- **目標**: ループ処理でゴールに到達
- **特徴**: 敵なし、大きなマップで反復処理を学習
- **学習内容**: for文、while文による効率的なコード作成

#### ステージ9 - 敵回避ステージ
- **目標**: 複数の敵を避けてゴールに到達  
- **敵**: 複数の静的な敵が配置
- **学習内容**: 複雑な経路計画と敵配置の理解

#### ステージ10 - 敵AI回避ステージ
- **目標**: 巡回する敵AIを避けて武器取得後、敵を倒してゴール
- **敵**: 巡回パターンを持つ動的AI敵
- **学習内容**: 敵の行動予測、戦略的思考、wait()の活用

## 技術改善

### 敵AI追跡ロジック改良
- **65/80ターン問題修正**: 同一距離時の方向選択を接触重視のx軸優先に変更
- **代替ルート検索**: デッドロック回避のため全方向探索モードを追加
- **探索強化**: 最後の目撃地点到達後の周辺探索機能

### 攻撃システム改善
- **1ターン1アクション**: 敵が方向転換と攻撃を同時に行う問題を修正
- **正確な方向制御**: 攻撃前に正しい方向への調整を必須化

## ファイル構成変更

### 新規追加
- `stages/stage07.yml` - 基本戦闘ステージ
- `stages/stage08.yml` - ループ練習ステージ  
- `stages/stage09.yml` - 敵回避ステージ
- `stages/stage10.yml` - 敵AI回避ステージ
- `tests/test_wait_command.py` - wait()API テスト
- `tests/test_multiple_students.py` - 複数学生テスト

### 主要変更
- `engine/api.py` - wait()API、プレイヤー設定統合
- `engine/commands.py` - WaitCommand実装
- `engine/game_state.py` - 敵AI処理、プレイヤー設定適用
- `engine/stage_loader.py` - プレイヤー設定検証・読み込み  
- `engine/__init__.py` - Stageクラス拡張
- `stages/stage01-09.yml` - プレイヤーHP統一(100に設定)

## 設定変更

### ステージ毎プレイヤー設定例
```yaml
player:
  start: [0, 0]
  direction: "E"
  hp: 100          # ステージ固有HP
  max_hp: 100      # ステージ固有最大HP
  attack_power: 30 # ステージ固有攻撃力
```

### 敵AI設定例
```yaml
enemies:
  - id: "orc1"
    type: "orc"
    position: [6, 2]
    hp: 45
    attack_power: 28
    behavior_pattern: "patrol"
    patrol_path: [[6,2], [6,3], [6,4], [6,3]]
```

## 教育効果

### 学習段階の明確化
1. **基礎移動** (Stage 1-3): 基本API習得
2. **戦闘システム** (Stage 4-7): attack()とゲームバランス理解
3. **プログラミング概念** (Stage 8): ループ処理とコード効率化
4. **戦略的思考** (Stage 9-10): 複雑な状況判断、wait()活用、AI行動予測

### 段階的難易度上昇
- Stage 7: 静的敵との基本戦闘
- Stage 8: プログラミング構造の理解  
- Stage 9: 複数敵との戦略的移動
- Stage 10: 動的AI敵との高度な戦術

## 互換性

### 後方互換性
- 既存ステージ(1-6)は変更なしで動作
- プレイヤー設定がないステージはデフォルト値を適用
- 既存のmain_*.pyファイルは変更なしで実行可能

### API拡張
- 既存API: `turn_left()`, `turn_right()`, `move()`, `attack()`, `pickup()`, `see()`
- 新規API: `wait()` - 1ターン待機
- see()API改良: `alerted`フィールド追加で敵の警戒状態を確認可能

## バグ修正

### 重要な修正
1. **プレイヤーHP問題**: ステージ10の設定が他ステージに影響していた問題を解決
2. **敵攻撃タイミング**: 1ターンで方向転換+攻撃を行う異常動作を修正
3. **追跡システム**: 65/80ターンでの振り切り問題を改善

### 安定性向上  
- 敵AI行動の予測可能性向上
- ステージ間でのプレイヤー設定独立性確保
- API応答の一貫性向上

## 開発者向け情報

### テスト環境改善
- プロジェクトルートの不要テストファイルをtests/ディレクトリに移動
- テストファイル構成の整理とメンテナンス性向上

### 設定システム拡張
- ステージ毎の柔軟な設定システム
- YAML設定の検証とエラーハンドリング強化
- プレイヤー・敵・アイテム設定の統合管理

## 次バージョンへの展望

v1.2.7により、基本的なローグライクゲーム学習フレームワークが完成しました。今後の拡張として：

- より複雑な敵AIパターン
- アイテム効果システムの強化  

などが検討されています。