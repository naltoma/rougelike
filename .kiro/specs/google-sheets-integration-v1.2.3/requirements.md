# Requirements Document

## はじめに

v1.2.3 Google Sheets連携機能は、Python初学者向けローグライク演習フレームワークに学生間のセッションログ共有機能を追加します。この機能により、学生は自分のステージ取り組み状況を共有フォルダにアップロードし、クラス全体の進捗状況を相互に閲覧できるようになります。これにより協調学習環境を構築し、学習モチベーションの向上と相互支援を促進します。

## Requirements

### Requirement 1: セッションログアップロード機能
**User Story:** 学生として、自分のステージ取り組み結果をクラスメートと共有したいので、セッションログをGoogle Sheetsにアップロードできるようにしたい。

#### Acceptance Criteria

1. WHEN 学生が`python upload.py`をステージ引数なしで実行 THEN システムは使用方法を表示して終了する
2. WHEN 学生が`python upload.py stage01`のようにステージIDを指定して実行 THEN システムは該当ステージのセッションログサマリをインデックス付きで表示する
3. WHERE セッションログサマリ表示において THE システムは実行終了時間、コード行数、アクション数、ゴール到達状況を含む
4. WHEN 学生が表示されたインデックス番号を選択 THEN システムは選択されたセッションログをGoogle Sheetsにアップロードする
5. IF 指定されたステージIDのセッションログが存在しない THEN システムはエラーメッセージを表示して終了する

### Requirement 2: Google認証システム
**User Story:** 学生として、セキュアにGoogle Sheetsにアクセスしたいので、適切な認証機能を使用したい。

#### Acceptance Criteria

1. WHEN 学生が初回アップロードを実行 THEN システムはGoogle OAuth認証フローを開始する
2. WHEN 認証が完了 THEN システムは認証情報をローカルに安全に保存する
3. IF 保存された認証情報が有効 THEN システムは再認証なしでGoogle Sheetsにアクセスする
4. IF 保存された認証情報が無効または期限切れ THEN システムは自動的に再認証フローを開始する
5. WHERE 認証エラーが発生した場合 THE システムは明確なエラーメッセージを表示する

### Requirement 3: Google共有フォルダ設定管理
**User Story:** 教員として、クラス全体のログ管理場所を指定したいので、共有フォルダの設定機能が必要である。

#### Acceptance Criteria

1. WHERE config.pyまたは設定ファイルにおいて THE システムはGoogle共有フォルダのURLを設定可能にする
2. IF Google共有フォルダのURLが設定されていない THEN システムは設定を促すメッセージを表示する
3. WHEN 設定されたURLが無効 THEN システムは適切なエラーメッセージを表示する
4. WHERE 共有フォルダ設定において THE システムは教員が学生に開示するリンクと連携する

### Requirement 4: ステージ別Google Sheetsファイル管理
**User Story:** クラス参加者として、ステージごとに整理されたログを閲覧したいので、ステージ別にファイルが管理されている必要がある。

#### Acceptance Criteria

1. WHEN 該当ステージのシートファイルが存在しない THEN システムは新しいGoogleスプレッドシートを作成する
2. WHERE 新規作成ファイルにおいて THE システムは`log-stage01`のような命名規則を使用する
3. IF 該当ステージのシートファイルが既に存在する THEN システムは既存ファイルに追記する
4. WHEN シートファイルを作成 THEN システムは4つのシートを用意する：タイムスタンプソート、アクション数ソート、コード行数ソート、オリジナルデータシート
5. WHERE 各ソートシートにおいて THE システムは該当する基準で自動ソート機能を提供する

### Requirement 5: マルチソート表示機能
**User Story:** 学生として、異なる観点からクラスメートの進捗を比較したいので、複数のソート方式でデータを閲覧したい。

#### Acceptance Criteria

1. WHERE タイムスタンプソートシートにおいて THE システムは実行終了時間順（新しい順）でデータを表示する
2. WHERE アクション数ソートシートにおいて THE システムはアクション数昇順でデータを表示する
3. WHERE コード行数ソートシートにおいて THE システムはコード行数昇順でデータを表示する
4. WHEN データが更新された THEN システムは全てのソートシートを自動的に再ソートする
5. IF ソート処理でエラーが発生 THEN システムはオリジナルデータシートにのみデータを記録する

### Requirement 6: 学生データ上書き管理
**User Story:** 学生として、同じステージに複数回取り組んだ際に最新結果が反映されるようにしたいので、重複アップロード時は上書き機能が必要である。

#### Acceptance Criteria

1. WHEN 同じ学生IDからの重複アップロードを検出 THEN システムは既存データを新しいデータで上書きする
2. WHERE 上書き処理において THE システムは全てのソートシートで一貫して更新を行う
3. IF 学生IDが一致するレコードが複数存在する THEN システムは最初に見つかったレコードを上書きする
4. WHEN 上書き処理が完了 THEN システムは上書き完了メッセージを表示する
5. WHERE データ整合性確保において THE システムは上書き後に全シートの整合性を検証する

### Requirement 7: セッションログデータ構造
**User Story:** システム管理者として、一貫したデータ分析を行いたいので、標準化されたデータ形式が必要である。

#### Acceptance Criteria

1. WHERE Google Sheetsデータ記録において THE システムはstudent_id、end_time、completed_successfully、action_count、code_linesの5つの必須フィールドを含む
2. WHERE student_idフィールドにおいて THE システムは6桁数字+英大文字1桁の形式を検証する
3. WHERE end_timeフィールドにおいて THE システムはISO8601形式（YYYY-MM-DDTHH:MM:SS）で記録する
4. WHERE completed_successfullyフィールドにおいて THE システムはboolean値（TRUE/FALSE）で記録する
5. WHERE action_count及びcode_linesフィールドにおいて THE システムは正の整数値で記録する
6. IF ソースコードの記録が必要な場合 THEN システムは別カラムに格納し、デフォルトでは非表示にする

### Requirement 8: エラーハンドリング及びユーザーフィードバック
**User Story:** 学生として、アップロード処理で問題が発生した際に適切な対処方法を知りたいので、明確なエラーメッセージと解決策が必要である。

#### Acceptance Criteria

1. WHERE ネットワーク接続エラーが発生した場合 THE システムは接続確認を促すメッセージを表示する
2. WHERE Google Sheets APIエラーが発生した場合 THE システムは認証確認を促すメッセージを表示する
3. WHERE 権限不足エラーが発生した場合 THE システムは共有フォルダの権限設定確認を促す
4. WHEN アップロードが正常完了 THEN システムは成功メッセージとアクセス用URLを表示する
5. WHERE 処理中において THE システムは進捗インジケーターまたは処理状況メッセージを表示する
