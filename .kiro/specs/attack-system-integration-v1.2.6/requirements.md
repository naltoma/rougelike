# Requirements Document

## はじめに

v1.2.6では、Python初学者向けローグライク演習フレームワークに攻撃システムを統合します。キャラクターの攻撃機能、敵AIのカウンター攻撃システム、攻撃ベースの新ステージ（stage04-06）を実装し、段階的学習における戦闘要素を導入します。この機能により、学習者は条件分岐とループの概念を攻撃・反撃のインタラクションを通じて習得できます。

## Requirements

### Requirement 1: キャラクター攻撃システム
**ユーザーストーリー:** プログラミング初学者として、キャラクターが敵を攻撃できる機能を使って、条件分岐の概念を戦闘を通じて学習したい。

#### 受け入れ基準
1. WHEN 学習者が `attack()` 関数を呼び出した THEN システムは キャラクターが向いている方向の1マス先への攻撃を実行しなければならない
2. IF キャラクターの正面1マス先に敵が存在する THEN システムは 敵にダメージを与えなければならない
3. IF キャラクターの正面1マス先に敵が存在しない THEN システムは 攻撃アクションを無効として処理し かつ アクションカウントを1増加させなければならない
4. WHEN `attack()` 関数が呼び出された THEN システムは 攻撃の成功・失敗に関わらず アクションカウントを1増加させなければならない
5. WHERE GUI表示において THE システムは 攻撃アニメーションまたは視覚的フィードバックを表示しなければならない

### Requirement 2: 敵AIカウンター攻撃システム
**ユーザーストーリー:** 学習者として、敵が攻撃に対して反撃する仕組みを通じて、アクションと反応の因果関係を理解したい。

#### 受け入れ基準
1. WHEN 敵がキャラクターから攻撃を受けた THEN 敵は 次のターンで反撃を実行しなければならない
2. IF 敵がキャラクターに攻撃された場合 AND 敵の向きがキャラクター方向でない THEN 敵は まず方向転換してから攻撃を実行しなければならない
3. WHILE 敵が攻撃を受けた状態にある THE 敵は 移動アクションを実行してはならない（攻撃と方向転換のみ）
4. WHEN 敵の反撃が実行された THEN システムは キャラクターのHPを減少させなければならない
5. IF 敵の正面1マス先にキャラクターが存在しない THEN 敵の攻撃は 無効として処理しなければならない

### Requirement 3: 敵の方向管理・追跡システム
**ユーザーストーリー:** 学習者として、敵が戦略的に行動する仕組みを通じて、より複雑な条件分岐とループの必要性を理解したい。

#### 受け入れ基準
1. WHEN 敵がキャラクターから攻撃を受けた THEN 敵は キャラクターを「監視対象」として記録しなければならない
2. WHILE 敵が監視状態にある THE 敵は 常にキャラクター方向を向くように方向調整を継続しなければならない
3. IF キャラクターが敵の側面から攻撃した THEN 敵の方向転換は 1ターン分の時間を消費しなければならない
4. IF キャラクターが敵の背面から攻撃した THEN 敵の方向転換は 2ターン分の時間を消費しなければならない
5. WHEN 敵が方向転換アクション（`turn_left()` または `turn_right()`）を実行した THEN システムは これを敵の1ターンとして処理し 次にキャラクターのターンに切り替えなければならない

### Requirement 4: Stage04実装（1回攻撃撃破）
**ユーザーストーリー:** 初学者として、単純な攻撃と移動を組み合わせた基本的な戦闘ステージを通じて、攻撃機能の使い方を習得したい。

#### 受け入れ基準
1. WHEN stage04が読み込まれた THEN システムは 1回の攻撃で撃破可能な敵を1体配置しなければならない
2. IF キャラクターが敵に1回攻撃した THEN 敵は 撃破状態となりゲームボードから除去されなければならない
3. WHEN 敵が撃破された AND キャラクターがゴール地点に到達した THEN システムは ステージクリアと判定しなければならない
4. WHERE stage04において THE システムは 攻撃機能の基本的な使用方法をガイダンスとして提供しなければならない
5. IF ステージ開始時 THEN システムは APIとして `attack()` 関数を利用可能にしなければならない

### Requirement 5: Stage05実装（3回連続攻撃撃破）
**ユーザーストーリー:** 学習者として、繰り返し攻撃が必要な敵との戦闘を通じて、ループ構造の実用性を理解したい。

#### 受け入れ基準
1. WHEN stage05が読み込まれた THEN システムは 3回の攻撃で撃破する敵を1体配置しなければならない
2. IF 敵が3回攻撃を受けた THEN 敵は 撃破状態となりゲームボードから除去されなければならない
3. WHILE 敵が生存している THE 敵は キャラクターからの攻撃に対してカウンター攻撃を実行しなければならない
4. IF キャラクターが敵から3回攻撃を受けた THEN キャラクターのHPは 0にならずに戦闘継続可能でなければならない（学習目的のための調整）
5. WHEN 敵が撃破された AND キャラクターがゴール地点に到達した THEN システムは ステージクリアと判定しなければならない

### Requirement 6: Stage06実装（HP10倍高耐久戦闘）
**ユーザーストーリー:** 学習者として、長期戦闘を通じて効率的なループとアルゴリズムの重要性を体感したい。

#### 受け入れ基準
1. WHEN stage06が読み込まれた THEN システムは キャラクターと敵のHPをstage04の10倍に設定しなければならない
2. WHERE ステージレイアウトにおいて THE システムは キャラクター開始位置を右下、敵配置を右上、ゴールを左上に設定しなければならない
3. WHILE 戦闘が継続中 THE システムは HP管理と攻撃回数のカウントを正確に維持しなければならない
4. IF 敵のHPが0になった THEN システムは 敵を撃破状態として処理しなければならない
5. WHEN キャラクターがゴール地点に到達した AND すべての敵が撃破された THEN システムは ステージクリアと判定しなければならない

### Requirement 7: HP・ダメージシステム統合
**ユーザーストーリー:** システム設計者として、既存のゲームエンジンと互換性のあるHP・ダメージ管理システムを導入したい。

#### 受け入れ基準
1. WHEN ゲームが開始された THEN システムは キャラクターと敵にステージ仕様に応じたHPを設定しなければならない
2. IF 攻撃が成功した THEN システムは ターゲットのHPから固定ダメージ値を減算しなければならない
3. WHILE ゲーム実行中 THE システムは HP状態をGUI上でリアルタイム表示しなければならない
4. WHEN HPが0以下になった THEN システムは 対象キャラクターを「撃破」状態として処理しなければならない
5. IF キャラクターのHPが0以下になった THEN システムは ゲーム実行を停止し ステージ失敗として判定しなければならない

### Requirement 8: 既存システムとの統合
**ユーザーストーリー:** 開発者として、新しい攻撃システムが既存のv1.2.5機能（速度制御、セッションログ、初回確認モード）と完全に互換性を持つことを確認したい。

#### 受け入れ基準
1. WHEN 攻撃アクションが実行された THEN システムは 7段階速度制御（v1.2.5）に従って実行速度を調整しなければならない
2. IF 初回確認モード（v1.2.4）が有効 THEN システムは 攻撃システムの説明を含むステージガイダンスを表示しなければならない
3. WHERE セッションログ記録において THE システムは 攻撃回数と戦闘結果をログデータに含めなければならない
4. WHEN ステップ実行モードが使用された THEN システムは 各攻撃アクションを個別のステップとして実行しなければならない
5. WHEN `upload_webhook.py stage04` コマンドが実行された THEN システムは 攻撃ベースステージの完了データをGoogle Sheetsに送信しなければならない

### Requirement 9: ターン制システム
**ユーザーストーリー:** 学習者として、キャラクターと敵が交互にアクションを実行するターン制バトルシステムを通じて、順次実行の概念を理解したい。

#### 受け入れ基準
1. WHEN ゲームが開始された THEN システムは キャラクターのターンから開始しなければならない
2. WHEN キャラクターがアクション（`move()`, `turn_left()`, `turn_right()`, `attack()`）を実行した THEN システムは 敵のターンに切り替えなければならない
3. WHEN 敵がアクション（移動、方向転換、攻撃）を実行した THEN システムは キャラクターのターンに切り替えなければならない
4. WHILE ターン制実行中 THE システムは 各アクションがターン消費することを明確に示さなければならない
5. IF 壁に向かって移動やアクションが無効な場合でも THEN システムは それを1ターンとしてカウントしなければならない

### Requirement 10: テスト・品質保証
**ユーザーストーリー:** 品質保証担当者として、攻撃システムが既存の88.9%テスト成功率を維持し、適切なテストカバレッジを持つことを確認したい。

#### 受け入れ基準
1. WHEN 攻撃システムのテストスイートが実行された THEN システムは 既存の88.9%成功率を維持または向上させなければならない
2. IF 新機能のユニットテストが作成された THEN テストは 攻撃、反撃、方向転換の各機能を個別にカバーしなければならない
3. WHERE 統合テストにおいて THE テストは stage04-06の完全なゲームフローを検証しなければならない
4. WHEN pytest実行時 THEN システムは 攻撃システム関連テストにマーカー分類を適用しなければならない
5. IF テストが失敗した場合 THEN システムは 詳細な失敗分析と再実行コマンドを提供しなければならない