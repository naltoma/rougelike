# Implementation Tasks - Attack System Integration v1.2.6

## 概要
attack機能導入、敵AIカウンター攻撃システム、stage04-06実装のための詳細実装タスク。
本タスクは承認された要求事項と設計文書に基づき、既存のv1.2.5システムとの互換性を維持します。

## フェーズ1: コア攻撃システム実装

### Task 1.1: Attack APIの実装
**ファイル**: `engine/api.py`
**説明**: 学生向けattack()関数の実装
**詳細実装手順**:
1. 既存のmove(), turn_left(), turn_right()関数の後にattack()関数を追加
2. 攻撃可能条件の検証（敵が正面1マス先に存在）
3. 攻撃失敗時でもターン消費する仕様の実装
4. GameStateへの攻撃アクション記録
5. 戦闘結果の返却（成功/失敗/敵撃破）

**実装サンプル**:
```python
def attack():
    """
    プレイヤーキャラクターが正面の敵を攻撃します。
    攻撃が成功すると敵にダメージを与え、失敗してもターンを消費します。
    
    Returns:
        bool: 攻撃が成功した場合True、失敗した場合False
    """
    game_state = get_game_state()
    # 攻撃実装ロジック
```

**テスト要件**:
- 正面に敵がいる場合の攻撃成功テスト
- 正面に敵がいない場合の攻撃失敗テスト
- 攻撃時のターン消費テスト
- 複数敵への攻撃優先順位テスト

### Task 1.2: HP管理システムの実装
**ファイル**: `engine/__init__.py`
**説明**: キャラクター、敵のHP管理システム
**詳細実装手順**:
1. CharacterクラスにHP属性追加（初期値: 100）
2. Enemyクラスに敵タイプ別HP設定
3. take_damage()メソッドの実装
4. is_alive()メソッドの実装
5. HP値の範囲制限（0-最大HP）

**実装サンプル**:
```python
@dataclass
class Character:
    # 既存フィールド...
    hp: int = 100
    max_hp: int = 100
    
    def take_damage(self, damage: int) -> bool:
        """ダメージを受ける。HPが0になったらFalseを返す"""
        # ダメージ処理実装
    
    def is_alive(self) -> bool:
        """生存確認"""
        return self.hp > 0
```

### Task 1.3: 戦闘処理エンジンの実装
**ファイル**: `engine/combat_system.py` (新規作成)
**説明**: 攻撃計算、ダメージ処理、撃破判定
**詳細実装手順**:
1. CombatSystemクラスの作成
2. プレイヤー攻撃処理（固定ダメージ30）
3. 敵攻撃処理（敵タイプ別ダメージ）
4. 戦闘結果の計算と記録
5. 撃破時の敵削除処理

## フェーズ2: ターンベース管理システム

### Task 2.1: ターン管理システムの拡張
**ファイル**: `engine/advanced_game_state.py`
**説明**: プレイヤー→敵の順序ターン管理
**詳細実装手順**:
1. TurnPhase Enumの追加（PLAYER, ENEMY）
2. current_turn_phase属性の追加
3. next_turn()メソッドの実装
4. ターン順序管理ロジック
5. ゲーム終了条件の統合

### Task 2.2: アクション統合システム
**ファイル**: `engine/commands.py`
**説明**: AttackCommandクラスの実装
**詳細実装手順**:
1. AttackCommandクラスの作成
2. execute()メソッドで戦闘処理呼び出し
3. undo()メソッドの実装（HP復元）
4. 既存コマンドシステムとの統合
5. アクション履歴の記録

## フェーズ3: 敵AIカウンター攻撃システム

### Task 3.1: 敵AI攻撃行動の実装
**ファイル**: `engine/enemy_system.py`
**説明**: 攻撃を受けた敵の反撃システム
**詳細実装手順**:
1. 敵の攻撃処理メソッド追加
2. プレイヤー方向検出ロジック
3. 攻撃可能距離（1マス）の判定
4. カウンター攻撃の実行
5. 攻撃後の方向調整（プレイヤーを向く）

**実装サンプル**:
```python
class Enemy:
    def counter_attack(self, game_state: AdvancedGameState) -> bool:
        """プレイヤーへのカウンター攻撃を実行"""
        # カウンター攻撃実装
        
    def turn_to_player(self, game_state: AdvancedGameState):
        """プレイヤー方向に向きを変更"""
        # 方向調整実装
```

### Task 3.2: 敵ターン処理の統合
**ファイル**: `engine/main_game_loop.py`
**説明**: 敵ターンでのカウンター攻撃実行
**詳細実装手順**:
1. 敵ターン処理ルーチンの修正
2. 攻撃を受けた敵の特定
3. カウンター攻撃の実行順序
4. 複数敵の攻撃順序管理
5. ターン終了条件の更新

## フェーズ4: 新ステージ実装

### Task 4.1: stage04.yml - 1回攻撃ステージ
**ファイル**: `stages/stage04.yml`
**説明**: 単純攻撃を要求するステージ
**詳細実装手順**:
1. 5x5グリッドの基本レイアウト
2. プレイヤー初期位置 (0,0)
3. 敵1体の配置 (2,0) - HP: 30
4. ゴール設定 (4,0)
5. 許可API: turn_left, turn_right, move, attack
6. クリア条件: 敵を倒してゴールに到達

**YAMLテンプレート**:
```yaml
id: stage04
name: "初回攻撃"
description: "敵を1回攻撃して倒してからゴールへ向かいます"
board:
  size: {w: 5, h: 5}
  repr:
    grid: |
      P.E.G
      .....
      .....
      .....
      .....
enemies:
  - {id: "enemy1", type: "goblin", pos: {x: 2, y: 0}, hp: 30}
api:
  allowed: [turn_left, turn_right, move, attack]
goals:
  - type: "reach_position"
    target: {x: 4, y: 0}
  - type: "defeat_all_enemies"
```

### Task 4.2: stage05.yml - 3回攻撃ステージ
**ファイル**: `stages/stage05.yml`
**説明**: 複数回攻撃が必要なステージ
**詳細実装手順**:
1. 6x5グリッドのレイアウト
2. HP: 90の強敵1体
3. 攻撃3回で撃破する設計
4. 障害物を配置して攻撃位置の調整が必要
5. カウンター攻撃への対応が必要

### Task 4.3: stage06.yml - HP10倍攻撃ステージ
**ファイル**: `stages/stage06.yml`
**説明**: 大型敵（HP: 300）との戦闘
**詳細実装手順**:
1. 7x5グリッドの広いレイアウト
2. 大型敵（HP: 300）1体
3. 攻撃10回で撃破
4. 複雑な地形と移動経路
5. 持久戦の戦略が必要

## フェーズ5: GUI統合

### Task 5.1: 攻撃アニメーション表示
**ファイル**: `engine/renderer.py`
**説明**: GUIでの攻撃視覚表現
**詳細実装手順**:
1. 攻撃エフェクト画像の追加
2. アニメーション表示ロジック
3. HP表示バーの実装
4. ダメージ数値の表示
5. 敵撃破エフェクト

### Task 5.2: ターン表示の実装
**ファイル**: `engine/renderer.py`
**説明**: 現在のターンフェーズ表示
**詳細実装手順**:
1. ターン情報パネルの追加
2. プレイヤーターン/敵ターンの表示
3. ターン数カウンターの更新
4. アクション待機状態の表示
5. 戦闘状態の視覚的フィードバック

## フェーズ6: テスト実装

### Task 6.1: 攻撃システムユニットテスト
**ファイル**: `tests/test_attack_system.py` (新規作成)
**説明**: attack()関数の包括テスト
**詳細実装手順**:
1. 攻撃成功/失敗のテストケース
2. HP計算の正確性テスト
3. ターン消費の確認テスト
4. 複数敵への攻撃テスト
5. エラーハンドリングテスト

### Task 6.2: 戦闘システム統合テスト
**ファイル**: `tests/test_combat_integration.py` (新規作成)
**説明**: 戦闘システム全体のテスト
**詳細実装手順**:
1. プレイヤー vs 敵の完全戦闘テスト
2. カウンター攻撃システムテスト
3. ターン順序管理テスト
4. ゲーム終了条件テスト
5. 複数戦闘シナリオテスト

### Task 6.3: 新ステージテスト
**ファイル**: `tests/test_stage04_06.py` (新規作成)
**説明**: stage04-06の動作テスト
**詳細実装手順**:
1. 各ステージのロード確認
2. クリア条件の正確性テスト
3. 敵配置と動作テスト
4. API制限の確認テスト
5. エラー処理テスト

## フェーズ7: 既存システムとの統合

### Task 7.1: セッションログ統合
**ファイル**: `engine/session_logging.py`
**説明**: 攻撃アクションのログ記録
**詳細実装手順**:
1. 攻撃アクションのログ形式定義
2. 戦闘結果の記録
3. ターン数の正確なカウント
4. HP変動の記録（デバッグ用のみ）
5. 既存ログシステムとの互換性

### Task 7.2: 品質保証システム統合
**ファイル**: `engine/quality_assurance.py`
**説明**: 攻撃関連の品質チェック
**詳細実装手順**:
1. 攻撃無限ループ検出
2. 戦闘効率の分析
3. コード品質メトリクス
4. 戦略的思考の評価
5. 教育的フィードバック生成

### Task 7.3: 速度制御統合
**ファイル**: `engine/enhanced_7stage_speed_control_manager.py`
**説明**: 攻撃アニメーション速度制御
**詳細実装手順**:
1. 攻撃アクションの速度制御対応
2. 戦闘アニメーションの速度調整
3. カウンター攻撃の表示速度
4. 高速実行時の戦闘処理最適化
5. デバッグ用超高速戦闘

## 実装優先順位

### 高優先度 (Phase 1-2)
- Task 1.1: Attack APIの実装
- Task 1.2: HP管理システムの実装
- Task 2.1: ターン管理システムの拡張
- Task 4.1: stage04.yml実装

### 中優先度 (Phase 3-4)
- Task 1.3: 戦闘処理エンジンの実装
- Task 3.1: 敵AIカウンター攻撃システム
- Task 4.2-4.3: stage05-06実装

### 低優先度 (Phase 5-7)
- Task 5.1-5.2: GUI統合
- Task 6.1-6.3: テスト実装
- Task 7.1-7.3: 既存システム統合

## 実装ガイドライン

### コーディング規約
- 既存のコーディングスタイルに従う
- 型ヒントを積極的に使用
- 詳細な日本語docstringを記述
- エラーハンドリングを必ず実装

### テスト要件
- 各機能に対応するユニットテスト
- 統合テストでの動作確認
- pytest実行成功率88.9%を維持
- エッジケースのテスト実装

### パフォーマンス要件
- 攻撃処理時間 < 50ms
- GUI更新レスポンス < 100ms
- メモリ使用量増加 < 20MB
- 既存機能への影響最小限

## 完了条件
1. 全てのタスクが実装完了
2. pytest実行で成功率88.9%以上維持
3. stage04-06が正常動作
4. 既存ステージの動作に影響なし
5. 教育的価値の検証完了

このタスクリストに従って実装を進めることで、段階的かつ確実にattack機能を統合できます。